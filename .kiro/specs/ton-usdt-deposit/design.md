# TON/USDT ìë™ ì…ê¸ˆ ì‹œìŠ¤í…œ - ê¸°ìˆ  ì„¤ê³„ ë¬¸ì„œ

> ì‘ì„±ì¼: 2026-01-16

---

## 1. ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         TON ì…ê¸ˆ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚  Telegram   â”‚     â”‚    Web      â”‚     â”‚   Admin     â”‚               â”‚
â”‚  â”‚    Bot      â”‚     â”‚  Frontend   â”‚     â”‚  Dashboard  â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚         â”‚                   â”‚                   â”‚                       â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                             â”‚                                           â”‚
â”‚                             â–¼                                           â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”‚
â”‚                    â”‚  Admin Backend  â”‚                                  â”‚
â”‚                    â”‚    (FastAPI)    â”‚                                  â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â”‚
â”‚                             â”‚                                           â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚         â–¼                   â–¼                   â–¼                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚ PostgreSQL  â”‚    â”‚    Redis    â”‚    â”‚ TON Network â”‚                 â”‚
â”‚  â”‚  (DB)       â”‚    â”‚  (Cache)    â”‚    â”‚  (Blockchain)â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. í•µì‹¬ ì»´í¬ë„ŒíŠ¸

### 2.1 TonExchangeRateService
ì‹¤ì‹œê°„ USDT/KRW í™˜ìœ¨ ì¡°íšŒ ë° ìºì‹±

```python
class TonExchangeRateService:
    CACHE_KEY = "exchange_rate:usdt_krw"
    CACHE_TTL = 30  # seconds
    
    async def get_usdt_krw_rate(self) -> Decimal:
        # 1. Redis ìºì‹œ í™•ì¸
        cached = await redis.get(self.CACHE_KEY)
        if cached:
            return Decimal(cached)
        
        # 2. CoinGecko API í˜¸ì¶œ
        rate = await self._fetch_from_coingecko()
        if not rate:
            # 3. Binance í´ë°±
            rate = await self._fetch_from_binance()
        
        # 4. ìºì‹œ ì €ì¥
        await redis.setex(self.CACHE_KEY, self.CACHE_TTL, str(rate))
        
        # 5. íˆìŠ¤í† ë¦¬ ì €ì¥
        await self._save_rate_history(rate)
        
        return rate
```


### 2.2 TonClient
TON ë„¤íŠ¸ì›Œí¬ ì—°ë™ í´ë¼ì´ì–¸íŠ¸

```python
class TonClient:
    USDT_MASTER = "EQCxE6mUtQJKFnGfaROTKOt1lZbDiiX1kCixRv7Nw2Id_sDs"
    USDT_DECIMALS = 6
    
    async def get_jetton_wallet_address(
        self,
        owner_address: str
    ) -> str:
        """ì†Œìœ ìì˜ USDT Jetton Wallet ì£¼ì†Œ ì¡°íšŒ"""
        # TON Center API ë˜ëŠ” tonapi.io ì‚¬ìš©
        pass
    
    async def get_jetton_transfers(
        self,
        jetton_wallet: str,
        after_lt: int | None = None
    ) -> list[JettonTransfer]:
        """Jetton ì „ì†¡ ë‚´ì—­ ì¡°íšŒ"""
        pass
```

### 2.3 DepositRequestService
ì…ê¸ˆ ìš”ì²­ ìƒì„± ë° ê´€ë¦¬

```python
class DepositRequestService:
    EXPIRY_MINUTES = 30
    AMOUNT_TOLERANCE = Decimal("0.005")  # 0.5%
    
    async def create_request(
        self,
        user_id: str,
        amount_krw: int,
        telegram_id: int | None = None
    ) -> DepositRequest:
        # 1. í™˜ìœ¨ ì¡°íšŒ
        rate = await exchange_service.get_usdt_krw_rate()
        
        # 2. USDT ê¸ˆì•¡ ê³„ì‚°
        amount_usdt = Decimal(amount_krw) / rate
        
        # 3. ê³ ìœ  ë©”ëª¨ ìƒì„±
        memo = self._generate_memo(user_id)
        
        # 4. ton:// URI ìƒì„±
        qr_uri = self._generate_ton_uri(amount_usdt, memo)
        
        # 5. QR ì´ë¯¸ì§€ ìƒì„±
        qr_image = qr_generator.generate(qr_uri)
        
        # 6. DB ì €ì¥
        request = DepositRequest(
            user_id=user_id,
            telegram_id=telegram_id,
            requested_krw=amount_krw,
            calculated_usdt=amount_usdt,
            exchange_rate=rate,
            memo=memo,
            qr_data=qr_uri,
            expires_at=datetime.utcnow() + timedelta(minutes=self.EXPIRY_MINUTES)
        )
        
        return request
    
    def _generate_memo(self, user_id: str) -> str:
        timestamp = int(time.time())
        random_suffix = secrets.token_hex(2)
        return f"user_{user_id[:8]}_{timestamp}_{random_suffix}"
    
    def _generate_ton_uri(
        self,
        amount_usdt: Decimal,
        memo: str
    ) -> str:
        # USDTëŠ” decimals=6ì´ë¯€ë¡œ Ã— 10^6
        nano_amount = int(amount_usdt * 1_000_000)
        return f"ton://transfer/{HOT_WALLET_ADDRESS}?amount={nano_amount}&text={memo}"
```

### 2.4 TonDepositMonitor
ì…ê¸ˆ ëª¨ë‹ˆí„°ë§ ë° ìë™ ìŠ¹ì¸

```python
class TonDepositMonitor:
    POLLING_INTERVAL = 10  # seconds
    
    async def start_polling(self):
        """Polling ë£¨í”„ ì‹œì‘"""
        while True:
            try:
                await self.check_new_deposits()
            except Exception as e:
                logger.error(f"Polling error: {e}")
            
            await asyncio.sleep(self.POLLING_INTERVAL)
    
    async def check_new_deposits(self):
        # 1. ìƒˆ Jetton transfer ì¡°íšŒ
        transfers = await ton_client.get_jetton_transfers(
            jetton_wallet=HOT_WALLET_JETTON_ADDRESS,
            after_lt=self.last_lt
        )
        
        for transfer in transfers:
            # 2. ë©”ëª¨ë¡œ ìš”ì²­ ë§¤ì¹­
            request = await self.match_deposit(transfer)
            if request:
                # 3. ìë™ ìŠ¹ì¸ ì²˜ë¦¬
                await deposit_processor.process_deposit(request, transfer)
    
    async def match_deposit(
        self,
        transfer: JettonTransfer
    ) -> DepositRequest | None:
        if not transfer.comment:
            return None
        
        # ë©”ëª¨ë¡œ ìš”ì²­ ì¡°íšŒ
        request = await db.query(DepositRequest).filter(
            DepositRequest.memo == transfer.comment,
            DepositRequest.status == "pending",
            DepositRequest.expires_at > datetime.utcnow()
        ).first()
        
        if not request:
            return None
        
        # ê¸ˆì•¡ ê²€ì¦ (Â±0.5% í—ˆìš©)
        min_amount = request.calculated_usdt * (1 - AMOUNT_TOLERANCE)
        if transfer.amount < min_amount:
            return None
        
        return request
```

### 2.5 DepositProcessor
ì…ê¸ˆ ì²˜ë¦¬ ë° ì”ì•¡ ì—…ë°ì´íŠ¸

```python
class DepositProcessor:
    async def process_deposit(
        self,
        request: DepositRequest,
        transfer: JettonTransfer
    ):
        async with db.transaction():
            # 1. ìš”ì²­ ìƒíƒœ ì—…ë°ì´íŠ¸
            request.status = "confirmed"
            request.tx_hash = transfer.tx_hash
            request.confirmed_at = datetime.utcnow()
            
            # 2. ì‚¬ìš©ì ì”ì•¡ ì—…ë°ì´íŠ¸
            await self.credit_balance(
                request.user_id,
                request.requested_krw
            )
            
            # 3. crypto_deposits ë ˆì½”ë“œ ìƒì„±
            deposit = CryptoDeposit(
                user_id=request.user_id,
                tx_hash=transfer.tx_hash,
                network=NetworkType.TON,
                amount_usdt=transfer.amount,
                amount_krw=request.requested_krw,
                exchange_rate=request.exchange_rate,
                memo=request.memo,
                status=TransactionStatus.COMPLETED
            )
            db.add(deposit)
            
            # 4. ì•Œë¦¼ ë°œì†¡
            await telegram_notifier.notify_deposit_confirmed(
                request.telegram_id,
                request.requested_krw
            )
```

---

## 3. ë°ì´í„° ëª¨ë¸

### 3.1 DepositRequest (ìƒˆ í…Œì´ë¸”)

```python
class DepositRequest(Base):
    __tablename__ = "deposit_requests"
    
    id: str                    # UUID
    user_id: str               # ì‚¬ìš©ì ID
    telegram_id: int | None    # Telegram ì‚¬ìš©ì ID
    requested_krw: int         # ìš”ì²­ ê¸ˆì•¡ (100000)
    calculated_usdt: Decimal   # ê³„ì‚°ëœ USDT
    exchange_rate: Decimal     # ì ìš© í™˜ìœ¨
    memo: str                  # ê³ ìœ  ë©”ëª¨ (unique)
    qr_data: str               # ton:// URI
    status: str                # pending/confirmed/expired/cancelled
    expires_at: datetime       # ë§Œë£Œ ì‹œê°„
    created_at: datetime
    confirmed_at: datetime | None
    tx_hash: str | None        # í™•ì¸ëœ íŠ¸ëœì­ì…˜ í•´ì‹œ
```

### 3.2 CryptoDeposit í™•ì¥

```python
class CryptoDeposit(Base):
    # ê¸°ì¡´ í•„ë“œ...
    network: NetworkType       # TRON / TON (ìƒˆ í•„ë“œ)
    memo: str | None           # TON ë©”ëª¨ (ìƒˆ í•„ë“œ)
```

---

## 4. API ìƒì„¸ ì„¤ê³„

### 4.1 ì…ê¸ˆ ìš”ì²­ API

```
POST /api/deposit/request

Request:
{
    "user_id": "550e8400-e29b-41d4-a716-446655440000",
    "telegram_id": 123456789,
    "amount_krw": 100000
}

Response:
{
    "request_id": "660e8400-e29b-41d4-a716-446655440001",
    "wallet_address": "EQBvW8Z5huBkMJYdnfAEM5JqTNLuuU8s0W5UfXQvGsHF3TGH",
    "amount_usdt": "68.027000",
    "exchange_rate": "1470.50",
    "memo": "user_550e8400_1705401234_a1b2",
    "qr_uri": "ton://transfer/EQBvW8Z5huBkMJYdnfAEM5JqTNLuuU8s0W5UfXQvGsHF3TGH?amount=68027000&text=user_550e8400_1705401234_a1b2",
    "qr_image_base64": "iVBORw0KGgoAAAANSUhEUgAA...",
    "expires_at": "2026-01-16T15:30:00Z",
    "expires_in_seconds": 1800
}
```

### 4.2 ì…ê¸ˆ ìƒíƒœ ì¡°íšŒ API

```
GET /api/deposit/status/{request_id}

Response (pending):
{
    "request_id": "660e8400-e29b-41d4-a716-446655440001",
    "status": "pending",
    "amount_krw": 100000,
    "amount_usdt": "68.027000",
    "expires_at": "2026-01-16T15:30:00Z",
    "remaining_seconds": 1234,
    "tx_hash": null,
    "confirmed_at": null
}

Response (confirmed):
{
    "request_id": "660e8400-e29b-41d4-a716-446655440001",
    "status": "confirmed",
    "amount_krw": 100000,
    "amount_usdt": "68.027000",
    "expires_at": "2026-01-16T15:30:00Z",
    "remaining_seconds": 0,
    "tx_hash": "abc123...",
    "confirmed_at": "2026-01-16T15:10:00Z"
}
```

---

## 5. Telegram Bot ì„¤ê³„

### 5.1 ëª…ë ¹ì–´

| ëª…ë ¹ì–´ | ì„¤ëª… |
|--------|------|
| /start | ë´‡ ì‹œì‘, ì‚¬ìš©ë²• ì•ˆë‚´ |
| /deposit | ì…ê¸ˆ ì‹ ì²­ (10ë§Œì›) |
| /deposit {ê¸ˆì•¡} | ì§€ì • ê¸ˆì•¡ ì…ê¸ˆ ì‹ ì²­ |
| /status | ìµœê·¼ ì…ê¸ˆ ìƒíƒœ ì¡°íšŒ |
| /balance | í˜„ì¬ ì”ì•¡ ì¡°íšŒ |
| /help | ë„ì›€ë§ |

### 5.2 ë©”ì‹œì§€ í…œí”Œë¦¿

**ì…ê¸ˆ ì•ˆë‚´ ë©”ì‹œì§€:**
```
ğŸ’° ì…ê¸ˆ ì•ˆë‚´

ê¸ˆì•¡: 100,000 KRW = 68.03 USDT
í™˜ìœ¨: 1 USDT = 1,470.50 KRW

ğŸ“ ì…ê¸ˆ ì£¼ì†Œ:
EQBvW8Z5huBkMJYdnfAEM5JqTNLuuU8s0W5UfXQvGsHF3TGH

ğŸ“ ë©”ëª¨ (í•„ìˆ˜):
user_550e8400_1705401234_a1b2

â° 30ë¶„ ë‚´ì— ì…ê¸ˆí•´ì£¼ì„¸ìš”!
ë§Œë£Œ: 2026-01-16 15:30:00

ğŸ“± QR ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ê±°ë‚˜ ì£¼ì†Œë¥¼ ë³µì‚¬í•˜ì„¸ìš”.
âš ï¸ ë©”ëª¨ë¥¼ ë°˜ë“œì‹œ ì…ë ¥í•´ì£¼ì„¸ìš”!
```

**ì…ê¸ˆ í™•ì¸ ë©”ì‹œì§€:**
```
âœ… ì…ê¸ˆ í™•ì¸ ì™„ë£Œ!

ì¶©ì „ ê¸ˆì•¡: 100,000ì›
ì…ê¸ˆ ê¸ˆì•¡: 68.03 USDT
í˜„ì¬ ì”ì•¡: 500,000ì›

ê°ì‚¬í•©ë‹ˆë‹¤! ğŸ‰
```

**ë§Œë£Œ ì•Œë¦¼ ë©”ì‹œì§€:**
```
â° ì…ê¸ˆ ì‹œê°„ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.

ìš”ì²­ ê¸ˆì•¡: 100,000ì›
ë§Œë£Œ ì‹œê°„: 2026-01-16 15:30:00

ë‹¤ì‹œ /deposit ëª…ë ¹ì–´ë¡œ ì‹ ì²­í•´ì£¼ì„¸ìš”.
```

---

## 6. ë³´ì•ˆ ì„¤ê³„

### 6.1 Hot Wallet ë³´ì•ˆ
- ìµœì†Œ ì”ê³ ë§Œ ìœ ì§€ (ì˜ˆ: 1,000 USDT)
- ì´ˆê³¼ë¶„ ìë™ Cold Wallet ì´ë™
- ë‹ˆëª¨ë‹‰ ì•”í˜¸í™” ì €ì¥

### 6.2 ìŠ¤ìº  Jetton ë°©ì§€
```python
USDT_MASTER_ADDRESS = "EQCxE6mUtQJKFnGfaROTKOt1lZbDiiX1kCixRv7Nw2Id_sDs"

def validate_jetton_transfer(transfer: JettonTransfer) -> bool:
    # Master ì£¼ì†Œ ê²€ì¦
    if transfer.jetton_master != USDT_MASTER_ADDRESS:
        logger.warning(f"Invalid Jetton master: {transfer.jetton_master}")
        return False
    return True
```

### 6.3 Rate Limiting
```python
# ì…ê¸ˆ ìš”ì²­: ë¶„ë‹¹ 5íšŒ
@limiter.limit("5/minute")
async def create_deposit_request(...):
    pass

# ìƒíƒœ ì¡°íšŒ: ë¶„ë‹¹ 30íšŒ
@limiter.limit("30/minute")
async def get_deposit_status(...):
    pass
```

---

## 7. ëª¨ë‹ˆí„°ë§

### 7.1 ë©”íŠ¸ë¦­
- ì…ê¸ˆ ìš”ì²­ ìˆ˜ (ë¶„ë‹¹/ì‹œê°„ë‹¹/ì¼ë‹¹)
- ì…ê¸ˆ ì„±ê³µë¥ 
- í‰ê·  ì²˜ë¦¬ ì‹œê°„
- ë§Œë£Œìœ¨
- í•«ì›”ë › ì”ì•¡

### 7.2 ì•Œë¦¼
- ê³ ì•¡ ì…ê¸ˆ (100ë§Œì› ì´ìƒ)
- ì´ìƒ ê±°ë˜ (ë©”ëª¨ ë¶ˆì¼ì¹˜)
- í•«ì›”ë › ì”ì•¡ ë¶€ì¡±
- ì‹œìŠ¤í…œ ì˜¤ë¥˜

---

## 8. ì°¸ê³  ìë£Œ

- TON ê³µì‹ ë¬¸ì„œ: https://docs.ton.org/
- tonapi.io API: https://tonapi.io/api-v2
- pytoniq: https://github.com/yungwine/pytoniq
- USDT Jetton: https://tonviewer.com/EQCxE6mUtQJKFnGfaROTKOt1lZbDiiX1kCixRv7Nw2Id_sDs
